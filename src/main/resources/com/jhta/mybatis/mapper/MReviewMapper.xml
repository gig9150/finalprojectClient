<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.jhta.mybatis.mapper.mreview">
	<select id="getinfo" parameterType="int" resultType="mreview">
		select * from mreview where mReviewNum=#{mReviewNum}
	</select>
	
	<select id="reviewList" resultType="reviewBoard" parameterType="hashmap">
	<![CDATA[
		select * from(
		    select aa.*,rownum rnum from (
		        select mem.memName, mr.mscore, mr.rcontent, mr.liketotal, mr.mreviewdate
		        from membership mem, mreview mr 
		        where mem.memNum=mr.memNum and mr.filmNum=#{filmNum} order by mreviewdate desc
		    )aa
		)where rnum<=#{rowCount}
	]]>
	</select>
	
	<select id="count" parameterType="int" resultType="int">
		select nvl(count(*),0) from
        mreview where filmnum=#{filmnum}
		order by mreviewdate desc
	</select>
	
	<!-- 관람평작성 조건에 부합하는지 확인하는 매퍼 -->
	<select id="chkReview" resultType="hashmap" parameterType="hashmap">
            select (
            	select count(*) review from mreview mr, film f,(select chargenum from charge where memnum=#{memNum}) c
           		where f.filmnum=mr.filmnum and c.chargenum=mr.chargenum and f.filmnum=#{filmNum}) reviewChek,
           			(select count(*) from charge where chargenum = any (select chargenum from book where mschedulenum =
            	(select mschedulenum from mschedule where purchasefilmnum= (select purchasefilmnum from purchasefilm where filmnum=#{filmNum})))
            	and memnum = #{memNum}) buyCheck,
            nvl((select chargenum from charge where chargenum = any (select chargenum from book where mschedulenum =
            	(select mschedulenum from mschedule where purchasefilmnum= (select purchasefilmnum from purchasefilm where filmnum=#{filmNum})))
            	and memnum = #{memNum}),0) chargenum
            from dual
	</select>
	
	<!-- 리뷰테이블에 관람평 insert시키기 -->
	<insert id="writeReview" parameterType="mreview">
		insert into mreview values(MREVIEWNUM.nextval, 
		rContent=#{rContent}, 0, mScore=#{mScore}, memNum=#{memNum},filmNum=#{filmNum}, chargeNum=#{chargeNum},mReviewDate=sysdate)
	</insert>
	
	<select id="movieGrade" parameterType="int" resultType="int">
		 select avg(mscore) avg from mreview where filmNum=#{filmNum}
	</select>
	
</mapper>